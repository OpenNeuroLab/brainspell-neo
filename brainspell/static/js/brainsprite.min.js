function brainsprite(c){function a(e,d){e.mozImageSmoothingEnabled=d;e.msImageSmoothingEnabled=d;e.imageSmoothingEnabled=d;return e}var b={};b.smooth=typeof c.smooth!=="undefined"?c.smooth:false;b.canvas=document.getElementById(c.canvas);b.context=b.canvas.getContext("2d");b.context=a(b.context,b.smooth);b.canvasY=document.createElement("canvas");b.contextY=b.canvasY.getContext("2d");b.canvasZ=document.createElement("canvas");b.contextZ=b.canvasZ.getContext("2d");b.onclick=typeof c.onclick!=="undefined"?c.onclick:"";b.colorBackground=typeof c.colorBackground!=="undefined"?c.colorBackground:"#000000";b.flagCoordinates=typeof c.flagCoordinates!=="undefined"?c.flagCoordinates:false;b.origin=typeof c.origin!=="undefined"?c.origin:{X:0,Y:0,Z:0};b.voxelSize=typeof c.voxelSize!=="undefined"?c.voxelSize:1;b.heightColorBar=0.04;b.sizeFont=0.075;b.colorFont=typeof c.colorFont!=="undefined"?c.colorFont:"#FFFFFF";if(b.flagCoordinates){b.spaceFont=0.1}else{b.spaceFont=0}b.sprite=document.getElementById(c.sprite);b.nbCol=b.sprite.width/c.nbSlice.Y;b.nbRow=b.sprite.height/c.nbSlice.Z;b.nbSlice={X:b.nbCol*b.nbRow,Y:c.nbSlice.Y,Z:c.nbSlice.Z};b.widthCanvas={X:0,Y:0,Z:0};b.heightCanvas={X:0,Y:0,Z:0,max:0};b.numSlice={X:Math.floor(b.nbSlice.X/2),Y:Math.floor(b.nbSlice.Y/2),Z:Math.floor(b.nbSlice.Z/2)};b.coordinatesSlice={X:0,Y:0,Z:0};c.overlay=typeof c.overlay!=="undefined"?c.overlay:false;if(c.overlay){b.overlay={};b.overlay.sprite=document.getElementById(c.overlay.sprite);b.overlay.nbCol=b.overlay.sprite.width/c.overlay.nbSlice.Y;b.overlay.nbRow=b.overlay.sprite.height/c.overlay.nbSlice.Z;b.overlay.nbSlice={X:b.overlay.nbCol*b.overlay.nbRow,Y:c.overlay.nbSlice.Y,Z:c.overlay.nbSlice.Z};b.overlay.ratio=b.overlay.nbSlice.Y/b.nbSlice.Y;b.overlay.canvasX=document.createElement("canvas");b.overlay.contextX=b.overlay.canvasX.getContext("2d");b.overlay.canvasY=document.createElement("canvas");b.overlay.contextY=b.overlay.canvasY.getContext("2d");b.overlay.canvasZ=document.createElement("canvas");b.overlay.contextZ=b.overlay.canvasZ.getContext("2d");b.overlay.opacity=typeof c.overlay.opacity!=="undefined"?c.overlay.opacity:1}else{b.overlay=false}c.colorMap=typeof c.colorMap!=="undefined"?c.colorMap:false;if(c.colorMap){b.colorMap={};b.colorMap.img=document.getElementById(c.colorMap.img);b.colorMap.min=c.colorMap.min;b.colorMap.max=c.colorMap.max;c.colorMap.hide=typeof c.colorMap.hide!=="undefined"?c.colorMap.hide:false;b.colorMap.canvas=document.createElement("canvas");b.colorMap.context=b.colorMap.canvas.getContext("2d");b.colorMap.canvas.width=b.colorMap.img.width;b.colorMap.canvas.height=b.colorMap.img.height;b.colorMap.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,b.colorMap.img.height,0,0,b.colorMap.img.width,b.colorMap.img.height)}b.getValue=function(h,g){if(!g){return NaN}var e,k,d,i,j,f;d=g.canvas.width;i=NaN;j=Infinity;for(xx=0;xx<d;xx++){e=g.context.getImageData(xx,0,1,1).data;k=Math.pow(e[0]-h[0],2)+Math.pow(e[1]-h[1],2)+Math.pow(e[2]-h[2],2);if(k<j){i=xx;j=k}}if(i){f=(i*(g.max-g.min)/(d-1))+g.min;return f}else{return NaN}};b.draw=function(j,h){b.numSlice[h]=j;b.widthCanvas.X=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.Y/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Y=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Z=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.heightCanvas.X=Math.floor(b.widthCanvas.X*b.nbSlice.Z/b.nbSlice.Y);b.heightCanvas.Y=Math.floor(b.widthCanvas.Y*b.nbSlice.Z/b.nbSlice.X);b.heightCanvas.Z=Math.floor(b.widthCanvas.Z*b.nbSlice.Y/b.nbSlice.X);b.heightCanvas.max=Math.max(b.heightCanvas.X,b.heightCanvas.Y,b.heightCanvas.Z);if(b.canvas.width!=(b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z)){b.canvas.width=b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z;b.canvas.height=Math.round((1+b.spaceFont)*(b.heightCanvas.max));b.context=a(b.context,b.smooth)}b.context.fillStyle=b.colorBackground;var i=Math.round(b.sizeFont*(b.heightCanvas.max));b.coordinatesSlice.X=(b.numSlice.X*b.voxelSize)-b.origin.X;b.coordinatesSlice.Y=(b.numSlice.Y*b.voxelSize)-b.origin.Y;b.coordinatesSlice.Z=((b.nbSlice.Z-b.numSlice.Z-1)*b.voxelSize)-b.origin.Z;if(b.overlay){var f=b.overlay.contextX.getImageData(b.numSlice.Y,b.numSlice.Z,1,1).data;b.voxelValue=b.getValue(f,b.colorMap)}else{b.voxelValue=NaN}switch(h){case"X":var d=((b.numSlice.X)%b.nbCol);var g=(b.numSlice.X-d)/b.nbCol;b.context.fillRect(0,0,b.widthCanvas.X,b.canvas.height);b.context.drawImage(b.sprite,d*b.nbSlice.Y,g*b.nbSlice.Z,b.nbSlice.Y,b.nbSlice.Z,0,(b.heightCanvas.max-b.heightCanvas.X)/2,b.widthCanvas.X,b.heightCanvas.X);if(b.overlay){b.overlay.canvasX.width=b.overlay.nbSlice.Y;b.overlay.canvasX.height=b.overlay.nbSlice.Z;b.overlay.contextX.globalAlpha=b.overlay.opacity;var d=((Math.round(b.overlay.ratio*b.numSlice.X))%b.overlay.nbCol);var g=(Math.round(b.overlay.ratio*b.numSlice.X)-d)/b.overlay.nbCol;b.overlay.contextX.drawImage(b.overlay.sprite,d*b.overlay.nbSlice.Y,g*b.overlay.nbSlice.Z,b.overlay.nbSlice.Y,b.overlay.nbSlice.Z,0,0,b.overlay.nbSlice.Y,b.overlay.nbSlice.Z);b.context.drawImage(b.overlay.canvasX,0,0,b.overlay.nbSlice.Y,b.overlay.nbSlice.Z,0,(b.heightCanvas.max-b.heightCanvas.X)/2,b.widthCanvas.X,b.heightCanvas.X)}if(b.flagCoordinates){b.context.font=i+"px Arial";b.context.fillStyle=b.colorFont;var k="x="+b.coordinatesSlice.X;var e=b.context.measureText(k).width;b.context.fillText(k,b.widthCanvas.X/2-e/2,Math.round(b.canvas.height-(i/2)))}break;case"Y":b.context.fillRect(b.widthCanvas.X,0,b.widthCanvas.Y,b.canvas.height);b.canvasY.width=b.nbSlice.X;b.canvasY.height=b.nbSlice.Z;for(xx=0;xx<b.nbSlice.X;xx++){var d=(xx%b.nbCol);var g=(xx-d)/b.nbCol;b.contextY.drawImage(b.sprite,d*b.nbSlice.Y+b.numSlice.Y,g*b.nbSlice.Z,1,b.nbSlice.Z,xx,0,1,b.nbSlice.Z)}b.context.drawImage(b.canvasY,0,0,b.nbSlice.X,b.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y);if(b.overlay){b.overlay.canvasY.width=b.overlay.nbSlice.X;b.overlay.canvasY.height=b.overlay.nbSlice.Z;b.overlay.contextY.globalAlpha=b.overlay.opacity;for(xx=0;xx<b.overlay.nbSlice.X;xx++){var d=xx%b.overlay.nbCol;var g=(xx-d)/b.overlay.nbCol;b.overlay.contextY.drawImage(b.overlay.sprite,d*b.overlay.nbSlice.Y+Math.round(b.overlay.ratio*b.numSlice.Y),g*b.overlay.nbSlice.Z,1,b.overlay.nbSlice.Z,xx,0,1,b.overlay.nbSlice.Z)}b.context.drawImage(b.overlay.canvasY,0,0,b.overlay.nbSlice.X,b.overlay.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y)}if((b.colorMap)&&(!b.colorMap.hide)){b.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,1,Math.round(b.widthCanvas.X+b.widthCanvas.Y*0.2),Math.round(b.heightCanvas.max*b.heightColorBar/2),Math.round(b.widthCanvas.Y*0.6),Math.round(b.heightCanvas.max*b.heightColorBar));b.context.font=i+"px Arial";b.context.fillStyle=b.colorFont;b.context.fillText(b.colorMap.min,b.widthCanvas.X+(b.widthCanvas.Y*0.2),Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(i)));b.context.fillText(b.colorMap.max,b.widthCanvas.X+(b.widthCanvas.Y*0.8)-b.context.measureText(b.colorMap.max).width,Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(i)))}if(b.flagCoordinates){b.context.font=i+"px Arial";b.context.fillStyle=b.colorFont;var k="y="+b.coordinatesSlice.Y;var e=b.context.measureText(k).width;b.context.fillText(k,b.widthCanvas.X+(b.widthCanvas.Y/2)-e/2,Math.round(b.canvas.height-(i/2)))}case"Z":b.context.fillRect(b.widthCanvas.X+b.widthCanvas.Y,0,b.widthCanvas.Z,b.canvas.height);b.canvasZ.width=b.nbSlice.X;b.canvasZ.height=b.nbSlice.Y;b.contextZ.rotate(-Math.PI/2);b.contextZ.translate(-b.nbSlice.Y,0);for(xx=0;xx<b.nbSlice.X;xx++){var d=(xx%b.nbCol);var g=(xx-d)/b.nbCol;b.contextZ.drawImage(b.sprite,d*b.nbSlice.Y,g*b.nbSlice.Z+b.numSlice.Z,b.nbSlice.Y,1,0,xx,b.nbSlice.Y,1)}b.context.drawImage(b.canvasZ,0,0,b.nbSlice.X,b.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z);if(b.overlay){b.overlay.canvasZ.width=b.overlay.nbSlice.X;b.overlay.canvasZ.height=b.overlay.nbSlice.Y;b.overlay.contextZ.rotate(-Math.PI/2);b.overlay.contextZ.translate(-b.overlay.nbSlice.Y,0);b.overlay.contextZ.globalAlpha=b.overlay.opacity;for(xx=0;xx<b.overlay.nbSlice.X;xx++){var d=xx%b.overlay.nbCol;var g=(xx-d)/b.overlay.nbCol;b.overlay.contextZ.drawImage(b.overlay.sprite,d*b.overlay.nbSlice.Y,g*b.overlay.nbSlice.Z+Math.round(b.overlay.ratio*b.numSlice.Z),b.overlay.nbSlice.Y,1,0,xx,b.overlay.nbSlice.Y,1)}b.context.drawImage(b.overlay.canvasZ,0,0,b.overlay.nbSlice.X,b.overlay.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z)}if(b.flagCoordinates){b.context.font=i+"px Arial";b.context.fillStyle=b.colorFont;var k="z="+b.coordinatesSlice.Z;var e=b.context.measureText(k).width;b.context.fillText(k,b.widthCanvas.X+b.widthCanvas.Y+(b.widthCanvas.Z/2)-e/2,Math.round(b.canvas.height-(i/2)))}}};b.clickBrain=function(g){var d=b.canvas.getBoundingClientRect();var i=g.clientX-d.left;var j=g.clientY-d.top;if(i<b.widthCanvas.X){var h=Math.round(b.nbSlice.Y*(i/b.widthCanvas.X));var f=Math.round(b.nbSlice.Z*(j-((b.heightCanvas.max-b.heightCanvas.X)/2))/b.heightCanvas.X);b.draw(Math.max(Math.min(h,b.nbSlice.Y-1),0),"Y");b.draw(Math.max(Math.min(f,b.nbSlice.Z-1),0),"Z")}else{if(i<(b.widthCanvas.X+b.widthCanvas.Y)){i=i-b.widthCanvas.X;sx=Math.round(b.nbSlice.X*(i/b.widthCanvas.Y));f=Math.round(b.nbSlice.Z*(j-((b.heightCanvas.max-b.heightCanvas.Y)/2))/b.heightCanvas.Y);b.draw(Math.max(Math.min(sx,b.nbSlice.X-1),0),"X");b.draw(Math.max(Math.min(f,b.nbSlice.Z-1),0),"Z")}else{i=i-b.widthCanvas.X-b.widthCanvas.Y;sx=Math.round(b.nbSlice.X*(i/b.widthCanvas.Z));h=Math.round(b.nbSlice.Y*(1-((j-((b.heightCanvas.max-b.heightCanvas.Z)/2))/b.heightCanvas.Z)));b.draw(Math.max(Math.min(sx,b.nbSlice.X-1),0),"X");b.draw(Math.max(Math.min(h,b.nbSlice.Y-1),0),"Y");b.draw(b.numSlice.Z,"Z")}}};b.drawAll=function(){b.draw(b.numSlice.X,"X");b.draw(b.numSlice.Y,"Y");b.draw(b.numSlice.Z,"Z")};if(b.onclick){b.canvas.addEventListener("click",function(d){b.clickBrain(d);b.onclick(d)},false)}else{b.canvas.addEventListener("click",b.clickBrain,false)}b.canvas.addEventListener("mousedown",function(d){b.canvas.addEventListener("mousemove",b.clickBrain,false)},false);b.canvas.addEventListener("mouseup",function(d){b.canvas.removeEventListener("mousemove",b.clickBrain,false)},false);b.drawAll();return b};
