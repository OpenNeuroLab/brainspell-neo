{% extends base.html %}

{% block header %}

    <title>View Article - Brainspell v2</title>

    <link href="/static/css/column.css" media="screen and (min-device-width: 800px)" rel="stylesheet">
    <link href="/static/css/view-article.css" rel="stylesheet">
    <link href="/static/css/view-article.css" rel="stylesheet">
    <script type="text/javascript" src="/static/js/definitions.js"></script>
    <script type="text/javascript" src="/static/js/brainsprite.min.js"></script>
    <link href="/static/css/select2.min.css" rel="stylesheet">
    <link href="/static/css/select2-bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="/static/js/spin.min.js"></script>
    <meta id="user_logged_in" data-name="{{ api_key }}">
    <!--Features to add words and corresponding definitions -->
    <script type="text/javascript" src="/static/js/cogatlas-cognitive.js"></script>
    <script type="text/javascript" src="/static/js/cogatlas-tasks.js"></script>
    <script type="text/javascript" src="/static/js/brainmap-behavioral.js"></script>
{% end %}

{% block content %}


    <!-- Page Content -->
    <div class="container">

        <div class="row">
            <div class="col-lg-12 text-center">
                <h1>Brainspell</h1>
                <p class="lead">An open, human-curated classification of neuroimaging literature.</p>
                {% if api_key != "" %}
                <div id="github_collections_div">
                  <label for="id_label_multiple">
                    Add to Github Collections:
                  </label>
                  <select class="js-example-basic-multiple js-states form-control" id="github_collections" multiple="multiple"></select>
                {% end %}
                </div>
            </div>
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container -->

    <div class="container" id="articleContents" style="padding-bottom: 30px;">
    </div>

    <div class="container" style="padding-bottom: 30px;">
        <div id="experiments"></div>
    </div>

    <!-- jQuery Version 1.11.1 -->
    <script src="/static/js/jquery.js"></script>
    <script type="text/javascript" src="/static/js/select2.full.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="/static/js/bootstrap.min.js"></script>
    <link href="/static/css/location-table.css" rel="stylesheet">
    <script src="/static/js/three.min.js"></script>
    <script src="/static/js/detector.js"></script>
    <script src='/static/js/subdivision-modifier.js'></script>
    <script src="/static/js/PLYLoader.js"></script>
    <script src="/static/js/trackball-controls.js"></script>
    <script src="/static/js/brain-widget.js"></script>
    <script src="/static/js/lodash.min.js"></script>

    <script>
    // TODO: clean up; start by logically separating the JS code into sections, then into functions, then into files
    var opts = {
      lines: 13 // The number of lines to draw
      , length: 28 // The length of each line
      , width: 14 // The line thickness
      , radius: 42 // The radius of the inner circle
      , scale: 0.25 // Scales overall size of the spinner
      , corners: 1 // Corner roundness (0..1)
      , color: '#000' // #rgb or #rrggbb or array of colors
      , opacity: 0.25 // Opacity of the lines
      , rotate: 0 // The rotation offset
      , direction: 1 // 1: clockwise, -1: counterclockwise
      , speed: 1 // Rounds per second
      , trail: 60 // Afterglow percentage
      , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
      , zIndex: 2e9 // The z-index (defaults to 2000000000)
      , className: 'spinner' // The CSS class to assign to the spinner
      , top: '82%' // Top position relative to parent
      , left: '50%' // Left position relative to parent
      , shadow: false // Whether to render a shadow
      , hwaccel: false // Whether to use hardware acceleration
      , position: 'absolute' // Element positioning
      };

      var target = document.getElementById('github_collections_div');
      var spinner = new Spinner(opts).spin(target);
      //console.log(spinner);
      $.get("/repos?list=1&pmid={{article_id}}", function(data, err){
        var data = JSON.parse(data);
        var coll_names = _.map(data, function(d){return d.name.replace("brainspell-collection-","")})
        var in_collection = _.map(_.filter(data, function(d){return d.in_collection}),
                                  function(d){return d.name.replace("brainspell-collection-","")});
        $("#github_collections").select2({data: coll_names, theme: "bootstrap"});
        $("#github_collections").val(in_collection).trigger("change")
        spinner.stop(target)
		$("#github_collections").on("select2:select", function (e) {
		  console.log("You want to add this pmid {{article_id}} to collection:", e.params.data.id)
		  $.post("/add-to-collection?"+$.param({pmid: {{article_id}},
		   collection:"brainspell-collection-"+e.params.data.id}), function(data, err){
			 console.log(err)
		   })
		});
	 $("#github_collections").on("select2:unselect", function (e) {
        console.log("You want to remove this pmid {{article_id}} from collection:", e.params.data.id)
		  $.post("/remove-from-collection?"+$.param({pmid: {{article_id}},
		   collection:"brainspell-collection-"+e.params.data.id}), function(data, err){
			 console.log(err)
		   })
		});
      }).fail(function(response){
        console.log("response is", response.statusText);
        spinner.stop(target);
        $("#github_collections").select2({placeholder: response.statusText});
        $("#github_collections").prop("disabled", true)
      });

        //Generates the popup widget when a vote element is clicked
      // TODO: might be worth making a class for popup, or potentially putting it in its own file
        function popup(elements, table_num = -1, column='NA',agr=-1,disagr=-1) {
            column = JSON.stringify(column);
            var targets = JSON.parse(elements);
            var agreements = 0;
            var disagree = 0;
            if (agr != -1) {
                agreements = agr;
            }
            if (disagr != -1) {
                disagree = disagr
            }
            var userVotedAgree = ""; // TODO: clean all of this up
            var userVotedDisagree = "";
            var votedAgree = false;
            var votedDisagree = false;
            var element = targets;
            if (typeof(targets) == "object") { // Specifies votes were provided
                element = targets[0];
                var votes = targets[1];
                if (votes != "NOVOTES") {
                    console.log(votes);
                    if (agreements != 0 || votes["up"].length != 0) {
                        agreements = votes["up"].length;
                    }
                    if (disagree != 0 || votes["down"].length != 0) {
                        disagree = votes["down"].length;
                    }
                    for (var i = 0; i < agreements; i++) {
                        if (votes["up"][i]["username"] == "{{github_username}}") {
                            userVotedAgree = " (including you)"
                            votedAgree = true;
                        }
                    }
                    for (var i = 0; i < disagree; i++) {
                        if (votes["down"][i]["username"] == "{{github_username}}") {
                            userVotedDisagree = " (including you)"
                            votedDisagree = true;
                        }
                    }
                }
            }
            value = "";
            if (definitions[element] == null) {
                value = definitions[capitalize(element)]
            }
            else {
                value = definitions[element]
            }
            var first = $("<div>", {"id":"myModal","class":"modal fade","role":"dialog"}).append(
                    $("<div>", {"class":"modal-dialog"}).append(
                        $("<div>", {"class":"modal-content"}).append(
                            $("<div>", {"class":"modal-header"}).append(
                    $("<button>", {"type":"button","class":"close","data-dismiss":"modal"})).append
                            ($("<h4>", {"class":"modal-title"}).text(element))).append(
                        $("<div>", {"class":"modal-body"}).append(
                                $("<p>").text(value)
                        ).append(
                                function() {
                                    if (table_num == -1) {
                                        return $("<a>", {
                                            "type": "button",
                                            "id": "agree",
                                            "class": "btn btn-default",
                                            "onclick": `updateVote('${element}','up')`
                                        }).text("Agree: " + agreements + userVotedAgree).attr("data-voted-agree", votedAgree);
                                    } else { // TODO: move this somewhere else; not clear that this is for table votes vs non-table
                                        return $("<a>", {
                                            "type": "button",
                                            "id":"agree",
                                            "class":"btn btn-default",
                                            "onclick":`updateTableVote(this, '${element}','up', ${table_num},${column})`
                                        }).text("Agree: " + agreements + userVotedAgree).attr("data-voted-agree", votedAgree);
                                    }
                                }
                        ).append(
                                function() {
                                    if (table_num == -1) {
                                        console.log(userVotedDisagree);
                                        return $("<a>", {
                                            "type": "button",
                                            "id": "disagree",
                                            "class": "btn btn-default",
                                            "onclick": `updateVote('${element}','down')`
                                        }).text("Disagree: " + disagree + userVotedDisagree).attr("data-voted-disagree", votedDisagree);

                                    } else {
                                        return $("<a>", {
                                            "type": "button",
                                            "id":"disagree",
                                            "class":"btn btn-default",
                                            "onclick":`updateTableVote(this, '${element}','down',${table_num},${column})`
                                        }).text("Disagree: " + disagree + userVotedDisagree).attr("data-voted-disagree", votedDisagree);
                                    }
                                }

                        ).append(
                            $("<div>", {"class":"modal-footer"}).append(
                                $("<button>", {"type":"button", "id": "closer", "class": "btn btn-default","data-dismiss":"modal"}).text("Close"))
                        )).css("z-index","2000")));

            $("#articleContents").append(first);
            if ($("#user_logged_in").data()["name"] == "None") {
                {% if api_key == "" %}
                $("#agree").hide();
                $("#disagree").hide();
                $("#closer").before("Please login to vote  ");
                {% end %}
            }
            // remove the modal from the DOM on hide
            $('#myModal').on('hidden.bs.modal', function(){
                $(this).remove();
            });
        }

        function searcher() {
            $('#search').keyup(function () {
                var current_query = $('#search').val();
                if (current_query != "") {
                    $(".list-group li").hide();
                    $(".list-group li").each(function () {
                        var current_keyword = $(this).text();
                        // case insensitive search
                        if (current_keyword.toLowerCase().indexOf(current_query.toLowerCase()) >= 0) {
                            $(this).show();
                        }
                    });
                } else {
                    $(".list-group li").show();
                }
            });
        }
        //Creates the mesh Popup whenever an "Add Descriptor" term is selected
        function meshAdder(term = descriptors, table_num = -1, column='NA') {
            var items = $("<ul>", {"class":"list-group"});
            for (var i = 0; i < term.length; i++) {
                var temp = JSON.stringify(term[i]["name"]);
                var single = $("<li>", {"class":"list-group-item"}).text(term[i]["name"]).attr("onclick", "popup('" + temp + "'," + table_num +"," +  JSON.stringify(column) +  ")").attr("data-toggle", "modal").attr("data-target", "#myModal");
                items.append(single);
            }
            var descriptor = $("<div>", {"class": "container"}).append(
                $("<div>", {"class":"row"}).append(
                    $("<div>",{"id":"descriptorModal", "class":"modal fade bs-example-modal-lg","tabindex":-1,"role":"dialog","aria-labelledby":"myLargeModalLabel"}).append(
                        $("<div>",{"class":"modal-dialog modal-lg"}).append(
                            $("<div>",{"class":"modal-content"}).append(
                                $("<div>",{"id":"custom-search-input"}).append(
                                    $("<div>",{"class":"input-group col-md-12"}).append(
                                            $("<input>",{"id":"search","type":"text","class":"form-control input-lg","placeholder":"Search Descriptor"})
                                    ).append(
                                        $("<span>",{"class":"input-group-btn"}).append(
                                                $("<button>",{"class":"btn btn-info btn-lg","type":"button"}).append(
                                                        $("<i>",{"class":"glyphicon glyphicon-search"})
                                                )
                                        )
                                    )
                                ).append(items)
                            )
                        )
                    )
                )
            ).css("z-index","1999");
            $("#articleContents").append(descriptor);
            $('#descriptorModal').on('hidden.bs.modal', function(){
                $(this).remove();
            });
            searcher(); //Activates search for each mesh term
        }


        var count = 1;
        var experimentsObj;
        var $resultClone = $("<div>", {"class": "row"}).css("padding", "10px");
        $("#articleContents").append($("<p>").css("color", "#c0c0c0").text("Loading..."));
        $($.ajax({
            type: "GET",
            url: "/json/article?pmid={{article_id}}"
        }).complete(function(o) { // MAIN INIT
            j = o.responseText;
            obj = JSON.parse(j);
            if (Object.keys(obj).length <= 1) { // TODO: what is this? should comment
                 window.location.replace("/search?q=%5BPMID%5D{{article_id}}&req=t");
            }

            try {
                metadata = JSON.parse(obj["metadata"].replace(/'/g, '"'))["meshHeadings"];
            } catch (err) { //Specifies a !CDATA left behind as a remnant of old database
                obj["metadata"] = obj["metadata"].slice(8,-2);
                metadata = JSON.parse(obj["metadata"].replace(/'/g, '"'))["meshHeadings"];
            }

            var user = JSON.parse(obj["metadata"].replace(/'/g, '"'))["user"];
            $("#articleContents").html("");
            $("#articleContents").append($("<h2>").text(obj["title"].replace(/\\"/g, '"').replace(/\\'/g, "'")));
            $("#articleContents").append($("<p>").css("color", "#c0c0c0").text(obj["authors"].split(",").join(", ").replace(/\\"/g, '"').replace(/\\'/g, "'")));
            $("#articleContents").append($("<p>", {"class": "make-column"}).text(obj["abstract"].replace(/\\"/g, '"').replace(/\\'/g, "'")));
            var linkParagraph = $("<p>");
            linkParagraph.append($("<a>").attr("href", "https://www.ncbi.nlm.nih.gov/pubmed/" + obj["pmid"]).text("PubMed"));

            {% if api_key != "" %}
            linkParagraph.append($("<span>").text(" | ")).append($("<a>").attr("href", "#!").attr("onclick", "$('#tableInputForm').fadeIn()").text("Add Table from Text File"));
            {% end %}

            $("#articleContents").append(linkParagraph);
            var tableInputForm = $("<div>").css("display", "none").attr("id", "tableInputForm").css("padding-bottom", "20px");
            var tableForm = $("<form>").append(
                $("<p>").text("Each coordinate should be on its own line, in the format \"x, y, z\" (without quotes).")
            ).append(
                $("<textarea>").attr("name", "values")
            ).attr("id", "experiments-table-input-form").append($("<input>").attr("type", "hidden").attr("name", "pmid").attr("value", "{{article_id}}")).append(
                $("<div>").append($("<button>").attr("class", "btn btn-default").css("margin-top", "5px").attr("onclick", "submitTextBoxExperimentsTable()").text("Submit"))
            );
            tableInputForm.append(tableForm);
            $("#articleContents").append(tableInputForm);
            
            var dropper = $("<div/>");
            if (metadata != undefined) { // TODO: what does this do?
                var metadataStr = "";
                for (var i = 0; i < metadata.length; i++) {
                    if (metadataStr != "") {
                        metadataStr = metadataStr + ", " + metadata[i]["name"];
                    }
                    else {
                        metadataStr = metadata[i]["name"];
                    }
                }
                var metadatalst = [];
                metadata = eval(metadata);
                for (var j = 0; j < metadata.length; j++) {
                    if (metadata[j]["vote"] != null) {
                        metadatalst.push([metadata[j]["name"], metadata[j]["vote"]])
                    }
                    else {
                        metadatalst.push([metadata[j]["name"], "NOVOTES"]); // TODO: not a good structure for this; should be a dictionary
                    }
                }
                // Create a modal for each term (approve or reject)

                dropper.addClass("dropdown");
                for (var i = 0; i < metadatalst.length; i++) {
                    var temp = metadatalst[i];
                    temp = JSON.stringify(temp);
                    var voteTagBtn = $("<button>").text(metadatalst[i][0]).attr("class", "dropbtn").attr("onclick", "popup('" + temp + "')").attr("data-toggle", "modal").attr("data-target", "#myModal")
                    if (metadatalst[i][1] != "NOVOTES") { // add visual feedback based on whether upvotes vs. downvotes are greater
                        if (metadatalst[i][1]["up"].length == metadatalst[i][1]["down"].length) {
                            voteTagBtn.css("color", "#FFA500"); // orange
                        } else if (metadatalst[i][1]["up"].length > metadatalst[i][1]["down"].length) {
                            voteTagBtn.css("color", "#228B22"); // dark green
                        } else {
                            voteTagBtn.css("color", "#ff0000"); // red
                        }
                    }
                    dropper.append(voteTagBtn);
                }


                $("#articleContents").append($("<p>").css("color", "#c0c0c0").text("MeSH descriptors: "));
            }
            dropper.append($("<button>",{"data-toggle":"modal","data-target":".bs-example-modal-lg","class":"dropbtn"}).text("Add MeSH descriptor").attr("onclick","meshAdder()").css("font-weight","bold"));
            $("#articleContents").append(dropper);

            //Add user based terms
            var user_terms = $("<div/>");
            user_terms.append($("<p>").css("color", "#c0c0c0").text("User descriptors: "));
            if (user != undefined) {
                for (var i = 0; i < user.length; i++) {
                    user_terms.append($("<button>").text(user[i]).attr("class", "dropbtn").attr("data-toggle", "modal"));
                }
            }
            user_terms.append($("<button>",{"data-toggle":"modal","data-target":".bs-example-modal-lg","class":"dropbtn", "id":"Addition"}).text("Add descriptor").attr("onclick","$('#userInput').fadeIn()").css("font-weight","bold"));
            var user_input = $("<div>").css("display", "none").attr("id", "userInput").css("padding-bottom", "20px");
            var user_data = $("<form>").append(
                    $("<p>",{"value":"Add tag below"})).append(
                $("<input>").attr("name", "values").attr("id", "user-tag-values")
            ).append($("<input>").attr("type", "hidden").attr("id","id").attr("name", "pmid").attr("value", "{{article_id}}")).append(
                $("<div>").append($("<button>").attr("class", "btn btn-default").attr("onclick", "submitUserTagToArticle()").css("margin-top", "5px").text("Submit"))
            );
            user_input.append(user_data);
            user_terms.append(user_input);
            $("#articleContents").append(user_terms);


            // TODO: add "action" once that endpoint is finished (? action?)
            var form = $('<div>', {'id':"locations"});
            // generate experiment tables
            experimentsObj = jQuery.parseJSON(obj["experiments"].replace(/'/g, '"'));
            for (var i = 0; i < experimentsObj.length; i++) {
                if (experimentsObj[i]["locations"].length > 0) {
                    var expContainer = $("<div>", {"id": "container" + experimentsObj[i]["id"], "class": "experimentContainer"});
                    var flagged = 0;
                    if ("flagged" in experimentsObj[i]) {
                        flagged = experimentsObj[i]["flagged"];
                    }
                    expContainer.append(experimentsTable(experimentsObj[i]["locations"], experimentsObj[i]['id'], i, flagged));
                    form.append(expContainer);
                    count++;
                }
            }
            // Generate BrainSprite Images
            // (setting display none until this does something useful)
            $("#articleContents").append("<div>" +
                    "<canvas style='max-width:100%;width:500px;display: none' id='3Dviewer'>" +
                    "<img id='spriteImg' class='hidden' src='/static/img/sprite.jpg'>" +
//                    "<img id='overlayImg' class='hidden' src='dmnSprite.png'>'" +
                    "</div>");
//            startloader();


            // if not on mobile
            $("body").append("<canvas id='3d' style='position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none'>");
            if (Detector.webgl) {
                renderer = new THREE.WebGLRenderer({
                    canvas: document.getElementById("3d"),
                    antialias: true, // to get smoother output
                    preserveDrawingBuffer: true, // to allow screenshot
                    alpha: true
                });
                renderer.setClearColor(0xffffff, 0);
                renderer.setPixelRatio(window.devicePixelRatio ? window.devicePixelRatio : 1);
            } else {
                console.log("ERROR: No WebGLRenderer available");
                renderer = new THREE.CanvasRenderer();
            }

            exp = experimentsObj;
            configureExperiments(experimentsObj);

            requestAnimationFrame(animate);
            // end brain widget generation

            form.append($("<div>").css("clear", "both"));

            if (experimentsObj.length > 0) {
                form.append($("<button>", {"id":"scorer","class":"btn btn-default","onclick":"submitHandler()"}).css("margin-top", "30px").text("Save Scores"));
                $("#articleContents").append(form);
            }
            $(".experimentContainer").each(function() {
                var elemID = $(this).attr("id").replace("container", "");
                if (document.getElementById(elemID) != null) {
                    var wrapper = document.createElement("div");
                    wrapper.append(document.getElementById(elemID));
                    wrapper.style.cssFloat = "left";
                    wrapper.style.styleFloat = "left";
                    wrapper.style.paddingRight = "30px";
                    document.getElementById('container' + elemID).insertBefore(
                        wrapper, document.getElementById('container' + elemID).firstChild);
                }
                $(this).append($("<div>").css("clear", "both"));
            });

    	}));
    </script>
    <div class="container">
        <div class="row">
        <div id="disqus_thread"></div>
        <script>

        var disqus_config = function () {
        this.page.url = "https://brainspell.herokuapp.com/view-article?id={{article_id}}";
        this.page.identifier = "{{article_id}}";
        };
        
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://brainspell.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                        
        </div>
    </div>

    <script>
    // TODO: make the voting, adding coordinates, deleting coordinates, etc. stay on the same page, and update the page on callback
        var ws = new WebSocket("wss://brainspell.herokuapp.com/api-socket");

        ws.onmessage = function (evt) {
            responseObj = JSON.parse(evt.data);
            // responseObj is the dictionary that the WebSocket returned
            if (responseObj["success"] == 1) {
                // if success, update the UI
                // TODO: add a helper function to refresh the entire UI
                /*
                if ($(btn).attr("data-voted-agree") == "true") {
                    // if they've already voted, then undo the vote in the UI
                    $(btn).attr("data-voted-agree", "false");
                    $(btn).text($(btn).text().replace(" (including you)", ""));
                    var votes = parseInt($(btn).text().replace("Agree: ", ""));
                    votes -= 1;
                    $(btn).text("Agree: " + votes);
                } else {
                    $(btn).attr("data-voted-agree", "true");
                    var votes = parseInt($(btn).text().replace("Agree: ", ""));
                    votes += 1;
                    $(btn).text("Agree: " + votes + " (including you)");
                }
                */

                // for now, just reloading
                location.reload();
            } else {
                console.log(responseObj);
            }
        };

        function configureExperiments(exp) {
            $("#experiments").html("");
            for(var i=0;i<exp.length;i++)
            {
                if(exp[i].locations.length==0)
                    continue;
                var widgetElem = $('<div class="experiment" id="'+exp[i].id+'">');
                var titleElem = $("<div>", {"class": "experiment-title"}).append($("<div>", {"class": "title"}));
                widgetElem.append(titleElem);
                var captionElem = $("<div>", {"class": "experiment-caption"}).append($("<div>", {"class": "caption"}));
                widgetElem.append(captionElem);
                var table = $("<table>").append($("<tbody>").append($("<tr>").append($("<td>").append($("<div>", {"class": "metaCoords"})))));
                widgetElem.append(table);
                $("#experiments").append(widgetElem);
                addExperiment(exp[i].id, exp[i]);
            }
        }
        function experimentsTable(array, position, experimentNumber, flagged) {
            var table = $("<table>").css("position", "relative");
            table.addClass("scroller");
            table.addClass("gradient-style");
            table.append($("<caption>").text("Experiment " + position));
            var contents = $('<tbody>');
            contents.addClass("experiments-tbody");
            var header = $('<tr>');
            header.append($("<td>", {"class": "experiment-header"}).text("X"));
            header.append($("<td>", {"class": "experiment-header"}).text("Y"));
            header.append($("<td>", {"class": "experiment-header"}).text("Z"));
            header.append($("<td>", {"class": "experiment-header"}).text("Z-effective"));
            contents.append(header);
            for (var i = 0; i < array.length; i++) {
                var row = $("<tr>", {"class": "experiment-table-row"}).attr("onclick", "rowClicked(this, " + experimentNumber + ")");
                array[i] = array[i].split(",");
                var z_score = array[i][3];
                for (var j in array[i].slice(0,3)) {
                    row.append($("<td>", {"style": "height:100%;"}).dblclick(function() {
                        $(this).css("padding-top", "5px").css("padding-bottom", "5px");
                        let textInput = $("<input>").attr("type", "text").css("width", "60%").val($(this).html());
                        $(this).html("");
                        $(this).append(textInput);
                        textInput.focus();
                    }).text(array[i][j]));
                }
                if (z_score == null) {
                    row.append($("<td>").css("padding-top", "5px").css("padding-bottom", "5px").append($("<input>", {
                        "type": "number",
                        "style": "width:60%;",
                        "step": "0.01",
                        "id": "" + position + i
                    })));
                }
                else {
//                    row.append($("<td>").css("padding-top", "5px").css("padding-bottom", "5px")).text(z_score);
                    row.append($("<td>", {"style": "height:100%;"}).dblclick(function() {
                        $(this).css("padding-top", "5px").css("padding-bottom", "5px");
                        let textInput = $("<input>").attr("type", "text").css("width", "60%").val($(this).html());
                        $(this).html("");
                        $(this).append(textInput);
                        textInput.focus();
                    }).text(z_score));
                }
                contents.append(row);
            }


            {% if api_key != ""  %}
            contents.append($("<tr>").attr("onclick", "addRowTo(" + experimentNumber + ", this)").append($("<td>").css("width","100%").css("padding-top", "5px").css("padding-bottom", "5px").append($("<a>", {"href":"/account", "style":"width:60%;","id":"" + position + i})).text("Add Row").css("text-align","center")));
            {% end %}

            table.append(contents);
            {% if api_key != ""  %}
            var footer = $("<tfoot>");
            footer.append($("<tr>").css("background-color", "white").css("width", "33%").css("float", "left").append($("<td>").append($("<a>").attr("href", "#!").attr("onclick", "deleteRow(" + experimentNumber + ")").text("Delete Row"))));
            footer.append($("<tr>").css("background-color", "white").css("width", "33%").css("float", "left").append($("<td>").append($("<a>").attr("href", "#!").attr("onclick", "splitTable(" + experimentNumber + ")").text("Split Table"))));
            var flagTableElem = $("<tr>").css("background-color", "white").css("width", "33%").css("float", "left");
            var linkElem = $("<a>").attr("href", "#!").attr("onclick", "flagTable(this, " + experimentNumber + ")").text("Flag Table");
            if (flagged == 1) {
                linkElem.css("color", "red");
                linkElem.text("Unflag Table");
            }
            flagTableElem.append($("<td>").append(linkElem));
            footer.append(flagTableElem);
            footer.append($("<button>", {"id":"cognitive","onclick": "meshAdder(cogAtlas_cognitive," + experimentNumber + ", 'C'" + ")", "data-toggle":"modal","data-target":".bs-example-modal-lg", "class":"dropbtn"}).text("Cognitive: "));


            //Add in table specific descriptors;
            if (experimentsObj[experimentNumber]["C"] != undefined) {
                var keys = experimentsObj[experimentNumber]["C"];
                console.log(keys);
                for (var k = 0; k < keys.length; k++) {
                    var temp = JSON.stringify(keys[k]["tag"]);
                    var term = $("<button>").text(keys[k]["tag"]).attr("class", "dropbtn").attr("onclick", "popup('" + temp + "'" + ',' + experimentNumber + ',' + JSON.stringify('C') + ',' + keys[k]["vote"]["up"].length + ',' + keys[k]["vote"]["down"].length + ")").attr("data-toggle", "modal").attr("data-target", "#myModal");
                    if ( keys[k]["vote"]["up"].length > keys[k]["vote"]["down"].length) {
                        term.css("color","green");
                    }
                    else if (keys[k]["vote"]["up"].length < keys[k]["vote"]["down"].length) {
                        term.css("color","red")
                    }
                    footer.append(term);
                }
            }
            footer.append($("<button>", {"id":"behavioral","onclick": "meshAdder(brainMap_behavioral," + experimentNumber + ", 'B')", "data-toggle":"modal","data-target":".bs-example-modal-lg", "class":"dropbtn"}).text("Behavioral: "));
            if (experimentsObj[experimentNumber]["B"] != undefined) {
                var keys = experimentsObj[experimentNumber]["B"];
                for (var k = 0; k < experimentsObj[experimentNumber]["B"].length; k++) {
                    var temp = JSON.stringify(keys[k]["tag"]);
                    var term = $("<button>").text(keys[k]["tag"]).attr("class", "dropbtn").attr("onclick", "popup('" + temp + "'" + ',' + undefined + ',' + undefined + ',' + keys[k]["vote"]["up"].length + ',' + keys[k]["vote"]["down"].length + ")").attr("data-toggle", "modal").attr("data-target", "#myModal");
                    if (keys[k]["vote"]["up"].length > keys[k]["vote"]["down"].length) {
                        term.css("color","green");
                    }
                    else if (keys[k]["vote"]["up"].length < keys[k]["vote"]["down"].length) {
                        term.css("color","red")
                    }
                    footer.append(term);
                }
            }
            footer.append($("<button>", {"id":"tasks","onclick": "meshAdder(cogAtlas_tasks," + experimentNumber + ", 'T')", "data-toggle":"modal","data-target":".bs-example-modal-lg", "class":"dropbtn"}).text("Tasks: "));
            if (experimentsObj[experimentNumber]["T"] != undefined) {
                var keys = experimentsObj[experimentNumber]["T"];
                for (var k = 0; k < experimentsObj[experimentNumber]["T"].length; k++) {
                    var temp = JSON.stringify(keys[k]["tag"]);
                    var term = $("<button>").text(keys[k]["tag"]).attr("class", "dropbtn").attr("onclick", "popup('" + temp + "'" + ',' + undefined + ',' + undefined + ',' + keys[k]["vote"]["up"].length + ',' + keys[k]["vote"]["down"].length + ")").attr("data-toggle", "modal").attr("data-target", "#myModal");
                    if (keys[k]["vote"]["up"].length > keys[k]["vote"]["down"].length) {
                        term.css("color","green");
                    }
                    else if (keys[k]["vote"]["up"].length < keys[k]["vote"]["down"].length) {
                        term.css("color","red")
                    }
                    footer.append(term);
                }
            }

            table.append(footer);
            {% end %}
            if (flagged) {
                table.addClass("flagged");
            }

            return table;
        }

        function drop(element) {
            if (element.lastChild.style.display == "block") {
                element.lastChild.style.display = "none";
            } else {
                element.lastChild.style.display = "block";
            }
        }

        // Close the dropdown menu if the user clicks outside of it
        window.onclick = function(event) {
          if (!event.target.matches('.dropbtn')) {

            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
              var openDropdown = dropdowns[i];
              if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
              }
            }
          }
        };

        // Add altered values to database
        function submitHandler() {
            var changes = {};
            for (var t = 0; t < experimentsObj.length; t++) {
                for (var row = 0; row < experimentsObj[t]["locations"].length; row++) {
                    var table = experimentsObj[t]["id"];
                    if ($("#" + table + row).val() != "") {
                        changes["" + table +','+ row] = $("#" + table + row).val()
                    }
                }
            }
            changes = JSON.stringify(changes);

            $.ajax({
                type: "POST",
                url: "/json/change-z-scores",
                data: {
                    "db-changes": changes,
                    "pmid": getID(),
                    "key": "{{api_key}}"
                }
            }).complete(function(o) {
                //console.log(o);
                location.reload();
            });
            //location.reload();
            //return true;
        }

        function submitTextBoxExperimentsTable() {
            var tableContents = $("#experiments-table-input-form").val();
            $.ajax({
                type: "POST",
                url: "/json/add-experiments-table-via-text",
                data: {
                    "values": values,
                    "pmid": pmid,
                    "key": "{{api_key}}"
                }
            }).complete(function(o) {
                location.reload();
            });
        }

        // Add new tag to database
        function submitUserTagToArticle() {
            var values = $("#user-tag-values").val();
            var pmid = "{{article_id}}";

            $.ajax({
                type: "POST",
                url: "/json/add-user-table-to-article",
                data: {
                    "values": values,
                    "pmid": pmid,
                    "key": "{{api_key}}"
                }
            }).complete(function(o) {
                location.reload();
            });
        }

        function addRowTo(element, rowDOM) {
            $(rowDOM).attr("onclick", "");
            rowDOM.innerHTML = '<td style="height: 100%; padding-top: 5px; padding-bottom: 5px;"><input type="text" style="width: 60%;" value="0" onkeypress="return checkIfRowSubmit(event, this, ' + element + ')"></td><td style="height: 100%; padding-top: 5px; padding-bottom: 5px;"><input type="text" style="width: 60%;" value="0" onkeypress="return checkIfRowSubmit(event, this, ' + element + ')"></td><td style="height: 100%; padding-top: 5px; padding-bottom: 5px;"><input type="text" style="width: 60%;" value="0" onkeypress="return checkIfRowSubmit(event, this, ' + element + ')"></td><td style="padding-top: 5px; padding-bottom: 5px;"><input type="number" style="width:60%;" step="0.01" value="0" onkeypress="return checkIfRowSubmit(event, this, ' + element + ')"></td>';
        }
        //On Enter Submits a new row to the database and refreshes page.
        function checkIfRowSubmit(e, input, experiment) {
            if (e.keyCode == 13) {
                var inputs = input.parentNode.parentNode.getElementsByTagName("input");
                var coords = inputs[0].value + "," + inputs[1].value + "," + inputs[2].value;
                $.ajax({
                    type: "GET",
                    url: "/json/add-row?pmid={{article_id}}&key={{api_key}}&experiment=" + experiment + "&coordinates=" + coords
                }).complete(function(o) {
                    j = o.responseText;
                    console.log(j);
                    obj = JSON.parse(j);
                    location.reload();
                });
                return false;
            }
        }
        // Delete a row from the table
        function deleteRow(element) {
            if (exp[element].selectedRow != null) {
                var r = exp[element].selectedRow;
                //var x = exp[element].locations[r][0];
                //var y = exp[element].locations[r][1];
                //var z = exp[element].locations[r][2];
                console.log(r);

                $.ajax({
                    type: "GET",
                    url: "/json/delete-row?pmid={{article_id}}&key={{api_key}}&experiment=" + element + "&row=" + r
                }).complete(function(o) {
                    j = o.responseText;
                    console.log(j);
                    obj = JSON.parse(j);
                    
                    location.reload();
                });
            }
        }
        //Breaks a table at a specified element
        function splitTable(element) {
            console.log(element);
            if (exp[element].selectedRow != null) {
                var r = exp[element].selectedRow;
                //var x = exp[element].locations[r][0];
                //var y = exp[element].locations[r][1];
                //var z = exp[element].locations[r][2];
                console.log(r);

                $.ajax({
                    type: "GET",
                    url: "/json/split-table?pmid={{article_id}}&key={{api_key}}&experiment=" + element + "&row=" + r
                }).complete(function(o) {
                    j = o.responseText;
                    console.log(j);
                    obj = JSON.parse(j);
                    location.reload();
                });
            }
        }
        //Specifies a table as invalid
        function flagTable(link, element) {
            console.log(element);
            //var x = exp[element].locations[r][0];
            //var y = exp[element].locations[r][1];
            //var z = exp[element].locations[r][2];
            $.ajax({
                type: "GET",
                url: "/json/flag-table?pmid={{article_id}}&key={{api_key}}&experiment=" + element
            }).complete(function(o) {
                j = o.responseText;
                console.log(j);
                obj = JSON.parse(j);
                if (link.innerHTML == "Flag Table") {
                    link.innerHTML = "Unflag Table";
                    link.style.color = "red";
                } 
                else {
                    link.innerHTML = "Flag Table";
                    link.style.color = "#337ab7";
                }
            });
        }

        //Returns the PMID of the current Article
        function getID(url) {
            if (!url) {
              url = window.location.href;
            }
            name = 'id';
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        // Updates the vote of a single table tag
        function updateTableVote(btn, tagName,direction,tableNum,column) {
            /*
            Example of AJAX to Websocket:
            $.ajax({
                type: "POST",
                url: "/update-table-vote",
                data: {
                    "tag_name": tagName,
                    "direction":direction,
                    "table_num":tableNum,
                    "id": getID(),
                    "column":column
                }
            }).complete(function(o) {
                //console.log(o);
                location.reload();
            });
            */
            var message = {
                "type": "update-table-vote",
                "payload": {
                    "tag_name": tagName,
                    "direction": direction,
                    "table_num": tableNum,
                    "pmid": getID(),
                    "column": column,
                    "username": "{{github_username}}",
                    "key": "{{api_key}}"
                }
            };
            ws.send(JSON.stringify(message));
        }
        //Updates votes for MeshDescriptors as a whole
        function updateVote(topic, direction) {
            $.ajax({
                type: "GET",
                url: "/json/toggle-user-vote?username={{github_username}}&pmid={{article_id}}&key={{api_key}}&direction=" + direction + "&topic=" + topic
            }).complete(function(o) {
                j = o.responseText;
                console.log(j);
                obj = JSON.parse(j);
                location.reload();
            });
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

//TODO Renders BrainSprite Graphics, Currently not used:
//        $.getScript("https://rawgit.com/SIMEXP/brainsprite.js/master/assets/brainsprite.js");
//        function startloader() {
//            $(window).load(function () {
//                var brain = brainsprite({
//                    canvas: "3Dviewer",
//                    sprite: "spriteImg",
////                    overlay: {
////                        sprite: "overlayImg",
////                        nbSlice: {"Y":79,'Z':63}
////                    },
//                    flagCoordinates: true,
//                    nbSlice: {"Y": 233, "Z": 189}
//                });
//            });
//            console.log("GRAPHICS LOADED");
//        }



        //TODO Evaluate whether this is even still necessary
        function send() {
            $.ajax({
                type: "POST",
                url: "/view-article",
                data: {
                    "changes": $("#submitter").val(),
                    "id": getID()
                }
            }).complete(function(o) {
                //console.log(o);
                location.reload();
            });
        }
    </script>

{% end %}
